<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Senior Buddy</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <header>
        <h1>Find a Senior Buddy</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="register-fresher.html">Fresher Registration</a></li>
                <li><a href="register-senior.html">Senior Registration</a></li>
                <li><a href="buddy-info.html">Buddy System</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section>
            <h2>Matched Seniors</h2>
            <p>Based on your interests, here are some senior buddies you can reach out to for help:</p>
            <div id="matched-seniors">
                <!-- Matched seniors will be displayed here by JavaScript -->
            </div>
        </section>
        <section>
            <h2>Ask for Help</h2>
            <form id="help-form">
                <label for="senior-email">Select Senior:</label>
                <select id="senior-email" name="senior-email" required>
                    <!-- Options will be populated by JavaScript -->
                </select><br><br>
                <label for="help-message">Your Message:</label><br>
                <textarea id="help-message" name="help-message" rows="4" cols="50" required></textarea><br><br>
                <button type="submit">Send Request</button>
            </form>
            <div id="help-response" style="margin-top:20px;"></div>
        </section>
    </main>
    <footer>
        <p>&copy; 2026 Fresher Buddy Assistance System</p>
    </footer>
    <script type="module">
// Initialize Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDXQftYOHC0WBycDo_DFX-IJKUQZW6t544",
  authDomain: "campus-hub-be22e.firebaseapp.com",
  projectId: "campus-hub-be22e",
  storageBucket: "campus-hub-be22e.firebasestorage.app",
  messagingSenderId: "187537836950",
  appId: "1:187537836950:web:7350b4af19d9faef422bb7",
  measurementId: "G-FPD1P0MT9D"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const matchedSeniorsDiv = document.getElementById('matched-seniors');
const seniorEmailSelect = document.getElementById('senior-email');

// Load fresher data from sessionStorage (set on registration)
const fresherRaw = sessionStorage.getItem('fresher');
const fresher = fresherRaw ? JSON.parse(fresherRaw) : null;

function tokenize(text){
    if(!text) return [];
    return text.split(/[,;|\/]+|\s+/).map(s=>s.trim().toLowerCase()).filter(Boolean);
}

function scoreMatch(f, s){
    let score = 0;
    const fTokens = tokenize(f.department || '');
    const sTokens = tokenize(s.department || '');
    // department match gives a boost
    if(f.department && s.department && f.department.trim().toLowerCase() === s.department.trim().toLowerCase()) score += 2;
    return score;
}

async function loadAndDisplaySeniors(){
    try {
        const querySnapshot = await getDocs(collection(db, "seniors"));
        const seniors = [];
        querySnapshot.forEach((doc) => {
            seniors.push({id: doc.id, ...doc.data()});
        });

        if(!fresher){
            matchedSeniorsDiv.innerHTML = '<p>No fresher data found. Please register first via the Fresher Registration page.</p>';
            return;
        }

        // compute scores
        const scored = seniors.map(s => ({s, score: scoreMatch(fresher, s)}));
        scored.sort((a,b)=>b.score - a.score);

        if(scored.length === 0){
            matchedSeniorsDiv.innerHTML = '<p>No seniors registered yet. Check back later!</p>';
            return;
        }

        // show header with fresher name
        const header = document.createElement('p');
        header.innerHTML = `<strong>Matches for ${fresher.name}</strong> — Department: ${fresher.department || 'N/A'}`;
        matchedSeniorsDiv.appendChild(header);

        const top = scored.filter(x=>x.score>0);
        const listToShow = top.length? top : scored.slice(0,5);

        listToShow.forEach(item => {
            const s = item.s;
            const div = document.createElement('div');
            div.className = 'nb-card';
            div.style.marginBottom = '0.8rem';
            div.innerHTML = `<h3 style="margin:.2rem 0">${s.name}</h3>
                             <div class="meta">${s.department || ''} — Year: ${s.year || ''} — Match Score: ${item.score}</div>
                             <div>Email: ${s.email || ''}</div>`;
            matchedSeniorsDiv.appendChild(div);

            const option = document.createElement('option');
            option.value = s.email || s.id;
            option.textContent = `${s.name} (${s.department || '—'})`;
            seniorEmailSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading seniors:', error);
        matchedSeniorsDiv.innerHTML = '<p>Error loading seniors. Please try again later.</p>';
    }
}

loadAndDisplaySeniors();

document.getElementById('help-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const selected = this['senior-email'].value;
    const message = this['help-message'].value.trim();
    document.getElementById('help-response').textContent = `Your request has been prepared for ${selected}. Message: "${message}"`;
    this.reset();
});
    </script>
</body>
</html>
