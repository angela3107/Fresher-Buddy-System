<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Senior Buddy</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <header>
        <h1>Find a Senior Buddy</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="register-fresher.html">Fresher Registration</a></li>
                <li><a href="register-senior.html">Senior Registration</a></li>
                <li><a href="buddy-info.html">Buddy System</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section>
            <h2>Matched Seniors</h2>
            <p>Based on your interests, here are some senior buddies you can reach out to for help:</p>
            <div id="matched-seniors">
                <!-- Matched seniors will be displayed here by JavaScript -->
            </div>
        </section>
        <section>
            <h2>Ask for Help</h2>
            <form id="help-form">
                <label for="senior-email">Select Senior:</label>
                <select id="senior-email" name="senior-email" required>
                    <!-- Options will be populated by JavaScript -->
                </select><br><br>
                <label for="help-message">Your Message:</label><br>
                <textarea id="help-message" name="help-message" rows="4" cols="50" required></textarea><br><br>
                <button type="submit">Send Request</button>
            </form>
            <div id="help-response" style="margin-top:20px;"></div>
        </section>
    </main>
    <footer>
        <p>&copy; 2026 Fresher Buddy Assistance System</p>
    </footer>
    <script>
        // Load fresher data from sessionStorage (set on registration)
        const fresherRaw = sessionStorage.getItem('fresher');
        const fresher = fresherRaw ? JSON.parse(fresherRaw) : null;

        // Load seniors from localStorage (populated when seniors register). Fallback to example list.
        const stored = localStorage.getItem('seniors');
        let seniors = stored ? JSON.parse(stored) : [
            { id:'s1', name: "Priya Sharma", email: "priya.senior@example.com", department: "CSE", interests: "AI, Coding, Sports" },
            { id:'s2', name: "Rahul Verma", email: "rahul.senior@example.com", department: "ECE", interests: "Robotics, Music, Clubs" }
        ];

        const matchedSeniorsDiv = document.getElementById('matched-seniors');
        const seniorEmailSelect = document.getElementById('senior-email');

        function tokenize(text){
            if(!text) return [];
            return text.split(/[,;|\/]+|\s+/).map(s=>s.trim().toLowerCase()).filter(Boolean);
        }

        function scoreMatch(f, s){
            let score = 0;
            const fTokens = tokenize(f.interests || f.mentoringInterests || '');
            const sTokens = tokenize(s.interests || s.mentoringInterests || s.skills || '');
            const set = new Set(sTokens);
            fTokens.forEach(t=>{ if(set.has(t)) score++; });
            // department match gives a small boost
            if(f.department && s.department && f.department.trim().toLowerCase() === s.department.trim().toLowerCase()) score += 1;
            return score;
        }

        if(!fresher){
            matchedSeniorsDiv.innerHTML = '<p>No fresher data found. Please register first via the Fresher Registration page.</p>';
        } else {
            // compute scores
            const scored = seniors.map(s => ({s, score: scoreMatch(fresher, s)}));
            scored.sort((a,b)=>b.score - a.score);
            // show header with fresher name and interests
            const header = document.createElement('p');
            header.innerHTML = `<strong>Matches for ${fresher.name}</strong> — Interests: ${fresher.interests}`;
            matchedSeniorsDiv.appendChild(header);

            const top = scored.filter(x=>x.score>0);
            const listToShow = top.length? top : scored.slice(0,5);

            listToShow.forEach(item => {
                const s = item.s;
                const div = document.createElement('div');
                div.className = 'nb-card';
                div.style.marginBottom = '0.8rem';
                div.innerHTML = `<h3 style="margin:.2rem 0">${s.name}</h3>
                                 <div class="meta">${s.department || ''} — Score: ${item.score}</div>
                                 <div>Interests: ${s.interests || s.mentoringInterests || s.skills || ''}</div>
                                 <div>Email: ${s.email || ''}</div>`;
                matchedSeniorsDiv.appendChild(div);

                const option = document.createElement('option');
                option.value = s.email || s.id;
                option.textContent = `${s.name} (${s.department || '—'})`;
                seniorEmailSelect.appendChild(option);
            });
        }

        document.getElementById('help-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const selected = this['senior-email'].value;
            const message = this['help-message'].value.trim();
            // In a real app we'd send this to a backend; here we just show a confirmation
            document.getElementById('help-response').textContent = `Your request has been prepared for ${selected}. Message: "${message}"`;
            this.reset();
        });
    </script>
</body>
</html>
